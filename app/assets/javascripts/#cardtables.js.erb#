var CP = ( function(){
     var table = {};
     var divs = [
    "<%= Card.new(1).make_div %>",
    "<%= Card.new(2).make_div %>",
    "<%= Card.new(3).make_div %>",
    "<%= Card.new(4).make_div %>",
    "<%= Card.new(5).make_div %>",
    "<%= Card.new(6).make_div %>",
    "<%= Card.new(7).make_div %>",
    "<%= Card.new(8).make_div %>",
    "<%= Card.new(9).make_div %>",
    "<%= Card.new(10).make_div %>",
    "<%= Card.new(11).make_div %>", 
    "<%= Card.new(12).make_div %>",
    "<%= Card.new(13).make_div %>",
    "<%= Card.new(14).make_div %>",
    "<%= Card.new(15).make_div %>",
    "<%= Card.new(16).make_div %>",
    "<%= Card.new(17).make_div %>",
    "<%= Card.new(18).make_div %>",
    "<%= Card.new(19).make_div %>",
    "<%= Card.new(20).make_div %>",
    "<%= Card.new(21).make_div %>",
    "<%= Card.new(22).make_div %>",
    "<%= Card.new(23).make_div %>",
    "<%= Card.new(24).make_div %>",
    "<%= Card.new(25).make_div %>",
    "<%= Card.new(26).make_div %>",
    "<%= Card.new(27).make_div %>",
    "<%= Card.new(28).make_div %>",
    "<%= Card.new(29).make_div %>",
    "<%= Card.new(30).make_div %>",
    "<%= Card.new(31).make_div %>",
    "<%= Card.new(32).make_div %>",
    "<%= Card.new(33).make_div %>",
    "<%= Card.new(34).make_div %>",
    "<%= Card.new(35).make_div %>",
    "<%= Card.new(36).make_div %>",
    "<%= Card.new(37).make_div %>",
    "<%= Card.new(38).make_div %>",
    "<%= Card.new(39).make_div %>",
    "<%= Card.new(40).make_div %>",
    "<%= Card.new(41).make_div %>",
    "<%= Card.new(42).make_div %>",
    "<%= Card.new(43).make_div %>",
    "<%= Card.new(44).make_div %>",
    "<%= Card.new(45).make_div %>",
    "<%= Card.new(46).make_div %>",
    "<%= Card.new(47).make_div %>",
    "<%= Card.new(48).make_div %>",
    "<%= Card.new(49).make_div %>",
    "<%= Card.new(50).make_div %>",
    "<%= Card.new(51).make_div %>",
    "<%= Card.new(52).make_div %>",
    "<%= Card.make_back %>"	 
     ];
     return {
	 stacks: {},
	 all_cards: [],

	 postopone: function(move,time){
	     setTimeout(function(){ 
		 CP[move.action].apply(CP,move.params);},time);	     
	 },

	 from_stack_move: function(stack_from,i,stack_to){
	     card = CP.stacks[stack_from].cards[i];
	     CP.move_card(stack_from,i,CP.stacks[stack_to].xnext,CP.stacks[stack_to].ynext,CP.stacks[stack_to].znext);
	     newstack = CP.stacks[stack_to];
	     newstack.cards[newstack.cards.length] = card;
	 },

	 move_card: function(stack_id,i,px,py,pz){
	     CP.stacks[stack_id].cards[i].move_to(px,py,pz);
	     CP.stacks[stack_id].remove_card(i,true);
	 },

	 create_table: function(ele,pxsize){
	     table = {
		 parent: ele,
		 pxsize: pxsize
	     };
	     ele.css({"font-size": pxsize+'px' }); 
	     ele.css({position: 'relative'});
	     return table;
	 },

	 get_pxsize: function(){
	     return table.pxsize;
	 },

	 add_card_to_stack: function(stack_id,card_id,show){
	     c = CP.create_card(card_id);
	     CP.stacks[stack_id].add_card(c);
	     if (show === true ) {
		 CP.show_stack(stack_id);
	     }
	 },

	 flip_card: function(stack_id,i,card_id){
	     card = CP.stacks[stack_id].cards[i];
	     CP.stacks[stack_id].remove_card(i,true);
	     card.get_div().hide();
	     CP.add_card_to_stack(stack_id,card_id,true);
	 },

	 show_stack: function(stack_id) {
	     CP.stacks[stack_id].show();
	 },

	 get_table: function(){
	     return table.parent;
	 },
	 // optimal size is 5px 
	 // every other position will scale

	 scale: function(x) {
	     return x* (this.get_pxsize() / 5)
	 },

	 get_passians_data: function(){
	     return { moves:
		      [{
			  action: "create_stack",
			  params: ["draw","0",30,30,20] },
		       {
			  action: "add_card_to_stack",
			  params: ["draw",53,true] },
		       {
			  action: "create_stack",
			  params: ["col1","V",200,30,20] },
		       {  
			  action: "add_card_to_stack",
			  params: ["col1",12,true] },
		       {
			  action: "create_stack",
			  params: ["col2","V",270,30,20] },
		       {  
			  action: "add_card_to_stack",
			  params: ["col2",53,true] },
		       {  
			  action: "add_card_to_stack",
			  params: ["col2",44,true] },
		       {
			  action: "create_stack",
			  params: ["col3","V",340,30,20] },
		       {  
			  action: "add_card_to_stack",
			  params: ["col3",53,true] },
		       {  
			  action: "add_card_to_stack",
			  params: ["col3",53,true] },
		       {  
			  action: "add_card_to_stack",
			  params: ["col3",1,true] },
       		       {
			  action: "create_stack",
			  params: ["col4","V",410,30,20] },
		       {  
			  action: "add_card_to_stack",
			  params: ["col4",53,true] },
		       {  
			  action: "add_card_to_stack",
			  params: ["col4",53,true] },
		       {  
			  action: "add_card_to_stack",
			  params: ["col4",53,true] },
		       {  
			  action: "add_card_to_stack",
			   params: ["col4",16,true] },
		       {
			  action: "create_stack",
			  params: ["col5","V",480,30,20] },
		       {
			  action: "add_cards_to_stack",
			  params: ["col5",[53,53,53,53,2],true] },
		       {
			  action: "create_stack",
			  params: ["col6","V",550,30,20] },
		       {
			  action: "add_cards_to_stack",
			  params: ["col6",[53,53,53,53,53,32],true] },
		       {
			  action: "create_stack",
			  params: ["col7","V",620,30,20] },
		       {
			  action: "add_cards_to_stack",
			  params: ["col7",[53,53,53,53,53,53,41],true] },
       		       {
			   action: "from_stack_move",
			   params: ["col4",3,"col7"]},

		       {   action: "move_stack",
			   params: ["col7",620,130]},

		       {   action: "move_stack",
			   params: ["col7",620,30]},
       		       {
			   action: "flip_card",
			   params: ["col4",2,44]},
       		       {
			   action: "from_stack_move",
			   params: ["col4",2,"col6"]},
		       {
			   action: "flip_card",
			   params: ["col4",1,45]},
       		       {
			  action: "create_stack",
			  params: ["draw_open","0",110,30,20] },	       
		       {
			   action: "add_card_to_stack",
			   params: ["draw",53]},
       		       
		       {
			   action: "flip_card",
			   params: ["draw",1,27]},
       		       {
			   action: "from_stack_move",
			   params: ["draw",1,"draw_open"]},
       		       {
			  action: "create_stack",
  			  params: ["up","V",710,30,100] },
       		       {
			   action: "from_stack_move",
			   params: ["col3",2,"up"]},
       		       {
			   action: "flip_card",
			   params: ["col3",1,28]},
       		       {
			   action: "from_stack_move",
			   params: ["draw_open",0,"up"]}
		      ]};
	 },
	 
	 add_cards_to_stack: function(stack_id,cards_ids,showstack){
	     for(i=0;i<cards_ids.length; i++){
		 CP.add_card_to_stack(stack_id,cards_ids[i],'card' + cards_ids[i],true);
	     }
	     if (showstack === true ){
		 CP.show_stack(stack_id);
	     }
	 },
	 move_stack: function(stack_id,px,py){
	     CP.stacks[stack_id].move_to(px,py);
	 },
         // **************************************************************************
	 /// STACK
         /// **************************************************************************
	 create_stack: function(stack_id,stack_type,xpos,ypos,pixdist){
	     xpos = CP.scale(xpos);
	     ypos = CP.scale(ypos);
	     pixdist = this.scale(pixdist);
	     var stack = {
		 id: stack_id,
		 cards: [],
		 parent: CP.get_table(),
		 tstack: stack_type,
		 dpx: pixdist,
		 x: xpos,
		 y: ypos,
		 xnext: xpos,
		 ynext: ypos,
		 znext: 1,
		 add_card: function(card){
		     this.cards[this.cards.length] = card;
		     card.set_position(this.xnext,this.ynext,this.znext);
		     this.update_next_pos();
		 },
		 show: function(){
		     for (var i=0;i< this.cards.length; i++){
			 this.cards[i].show();
			 }
		 },

		 insert_card: function (atpos,card) {
		     console.log(card.to_s());
		     var new_cards = [];
		     for ( var i=0;i<this.cards.length;i++){
			 if (i<atpos) {
			     new_cards[i] = this.cards[i];
			 }  else 
			     if ( i > atpos) {
				 new_cards[i+1] = this.cards[i];
			 }
	              }
		     new_cards[atpos] = card;
		     this.cards = new_cards;
		     for (var k=0; k< this.cards.length; k++){
			 console.log("K" + k );
			 console.log("Insert" + " "  + this.cards[k].to_s());
			 this.cards[k].show();
		     }
		     this.update_card_position(atpos).show();
		     
		 },

		 update_card_position: function(i){
		     
		     if(this.tstack === 'V') {
			 this.cards[i].set_position(this.x,this.dpx*i+this.y,i);
		      };
		     if (this.tstack === 'H') {
			 this.cards[i].set_position(this.x + this.dpx*i,this.y,i);
		     }
		     if (this.tstack === '0') {
			 this.cards[i].set_position(this.x,this.y,i);
		     }
		     return this.cards[i];
		 },
		 remove_card: function(atpos,showstack) {
		     this.cards.splice(atpos,1);
		     for(var i=atpos; i< this.cards.length; i++){
			 this.update_card_position(i);
		     };
		     this.update_next_pos();
		     if (showstack === true) {
			 this.show();
		     }
		 },
		 move_to:function(xpos,ypos){
		     xpos = CP.scale(xpos);
		     ypos = CP.scale(ypos);
		     this.x = xpos;
		     this.y = ypos;
		     for (var i=0;i< this.cards.length; i++){
			 if ( this.tstack === 'H' ) {
			     this.cards[i].move_to(xpos+this.dpx*i,ypos,i);
			 }
			 if ( this.tstack === 'V' ) {
			     this.cards[i].move_to(xpos,this.dpx*i+ypos,i);
			 }
			 if (this.tstack === '0'){
			     this.cards[i].move_to(xpos,ypos,i);
			 }
		     }
		     this.update_next_pos();  
		 },
		
		 update_next_pos: function(){
		     if (this.tstack === 'H' ) {
			 this.xnext = this.x + this.cards.length*this.dpx;
			 this.ynext = this.y;
		     }
		     if (this.tstack === 'V') {
			 this.ynext = this.y + this.cards.length*this.dpx;
			 this.xnext = this.x;
		     }
		     if (this.tstack === '0') {
			 this.ynext = this.y;
			 this.xnext = this.y;
		     }
		     this.znext = this.znext + 1;
		 },
		 jump_to:function(xpos,ypos){
		     xpos = CP.scale(xpos);
		     ypos = CP.scale(ypos);
		     this.x = xpos;
		     this.y = ypos;
		     for (var i=0;i< this.cards.length; i++){
			 if (this.tstack === 'H'){
			     this.cards[i].jump_to(xpos+this.dpx*i,ypos,i);
			 }
			 if (this.tstack === 'V'){
			     this.cards[i].jump_to(xpos,this.dpx*i+ypos,i);
			 }
			 if (this.tstack === '0'){
			     this.cards[i].jump_to(xpos,ypos,i);
			 }
		     }
		     this.update_next_pos();
		 },
		 
		 get_card: function(i) {
		     return this.cards[i];
		 }
	     };
	     CP.stacks[stack_id] = stack;
	     return stack;
	 },
          // ******************************************************************************
          // ******************************************************************************
          // CARD 
          // ******************************************************************************
          // ******************************************************************************

         create_card: function(card_id){
	     CP.all_cards[CP.all_cards.length] = card_id;
	     var card = {
	         card_id: card_id,
		 x: 0,
		 y: 0,
		 z: 0,
		 element_id: "card" + CP.all_cards.length ,
		 selected: true,
             to_s: function() {
		 return "id:" + this.card_id;
	     },
             jump_to: function(px,py,pz){
		 this.set_position(px,py,pz);
		 this.show();
	     },
	     make_div: function() {
		 if (this.card_id != 53 ) {
		     return "<div class='card' id='" + this.element_id + "'>" + divs[card_id-1] +  "</div>";
		 } else {
		     return "<div class='card' id='" + this.element_id + "'>" + divs[52] +  "</div>";
		 };
	     },         
	     get_div: function() {
		 return $('#' + this.element_id);
		 },
	     on_click: function(ele){
		 alert(JSON.stringify());
	     },
             set_position: function(px,py,pz){
		 px = CP.scale(px);
		 py = CP.scale(py);
		 this.x = px;
		 this.y = py;
		 this.z = pz;
	     },
	     show: function(){
		 this.get_div().remove();
		 this.parent = CP.get_table() || this.parent;
		 this.parent.prepend(this.make_div());
		 this.get_div().css({position: "absolute"}).css({left:this.x + "px",top:this.y+"px", zIndex:this.z });
		 if (this.selected){
		     this.get_div().css({"background-color" : ""});
		 }
		 else {
		     this.get_div().css({"background-color" : "white"});
		 }
		 this.get_div().click(this.on_click);
		
	     },
             move_to: function(px,py,pz) {
		 px = CP.scale(px);
		 py = CP.scale(py);
		 this.get_div().snabbt({ position:[px-this.x, py-this.y ,this.z],
					 duration: 500,
					 delay: 10,
					 easing: 'spring'
				         });
		 this.get_div().css({position: "absolute"}).css({left:this.x + "px",top:this.y+"px",zIndex: pz  })
	         this.x = px;
		 this.y = py;
		 this.z = pz;
	        }
		
	     };
	     return card;
	 }
     };
 }());


$(document).ready(function(){
     var ele = $("#cardtable");
     var table = CP.create_table(ele,6); 
    //  a = CP.get_data();
    //  for ( var i = 0; i<a.moves.length ; i++) {
    // 	move = a.moves[i];
    // 	CP.postopone(move,i*300);
    // };
     b = CP.get_passians_data();
    for ( var i = 0; i< b.moves.length ; i++) {
	move = b.moves[i];
	CP.postopone(move,i*300);
    };


});
